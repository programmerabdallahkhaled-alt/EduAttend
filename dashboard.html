<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>EduAttend Dashboard</title>

<style>
/* ======= GENERAL ======= */
*{box-sizing:border-box;margin:0;padding:0;font-family:"Tajawal",sans-serif}
body{background:linear-gradient(135deg,#e8f0ff,#f6f9ff);min-height:100vh;color:#0f2140}

:root{
  --primary:#2a4ea3;
  --primary-dark:#16356e;
  --grad:linear-gradient(135deg,#538bff,#2a4ea3);
  --surface:#ffffff;
  --card:#ffffff;
  --border:#dbe8ff;
  --muted:#657a96;
}

/* ======= MOBILE TOP BAR ======= */
.topbar{
  display:none;
  background:var(--primary);
  color:#fff;
  padding:14px;
  font-size:18px;
  font-weight:600;
  position:fixed;
  top:0;
  left:0;
  width:100%;
  z-index:200;
}
.topbar button{
  background:transparent;
  border:0;
  color:#fff;
  font-size:22px;
  margin-inline-end:10px;
  cursor:pointer;
}

/* ======= SIDEBAR ======= */
.sidebar{
  width:260px;
  background:#f0f6ff;
  border-left:6px solid var(--primary);
  padding:20px;
  position:fixed;
  right:0;
  top:0;
  height:100%;
  transition:.3s;
  z-index:150;
}
.sidebar.hidden{right:-300px}

.brand{font-size:22px;font-weight:700;color:var(--primary);text-align:center;margin-bottom:20px}
.menu{display:flex;flex-direction:column;gap:12px}
.menu button{
  padding:12px;
  border:0;
  border-radius:12px;
  background:#eef4ff;
  color:var(--primary-dark);
  cursor:pointer;
  font-size:15px;
  transition:.2s;
}
.menu button:hover{background:#dbe8ff}

/* ======= CONTENT ======= */
.content{
  padding:20px;
  margin-right:260px;
  transition:.3s;
}

.box{
  background:var(--card);
  padding:20px;
  border-radius:14px;
  box-shadow:0 5px 20px rgba(0,0,0,0.05);
  margin-bottom:20px;
}
.title{font-size:22px;font-weight:700;color:var(--primary-dark);margin-bottom:14px}

/* FILTER */
.filter-container{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px}
.tabBtn{padding:10px 16px;border-radius:100px;border:1px solid var(--border);background:#fff;color:var(--primary);cursor:pointer}
.tabBtn.active{background:var(--grad);color:#fff;border:0}

/* FORM */
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:10px}
.student-input{padding:12px;border-radius:10px;border:1px solid var(--border)}
.add-btn{grid-column:span 2;padding:12px;border:0;border-radius:10px;background:var(--grad);color:#fff;font-size:16px;cursor:pointer}

/* TABLE */
.table-wrapper{overflow:auto}
.res-table{width:100%;border-collapse:collapse;min-width:600px}
.res-table th,.res-table td{padding:12px;border-bottom:1px solid #eef2ff;text-align:center}

/* MOBILE TABLE */
@media(max-width:520px){
  .res-table thead{display:none}
  .res-table tr{display:block;margin-bottom:10px;background:#fff;padding:12px;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,0.05)}
  .res-table td{display:flex;justify-content:space-between;padding:6px 0}
  .res-table td::before{content:attr(data-label);font-weight:700;color:var(--primary);margin-inline-end:8px}
}

/* LESSON CARDS */
.list-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
.lesson-card{background:#fff;padding:14px;border-radius:12px;border:1px solid var(--border);cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,0.05)}
.lesson-card h4{margin:0 0 6px 0;color:var(--primary-dark)}
.lesson-meta{color:var(--muted);font-size:14px}

@media(max-width:900px){.list-grid{grid-template-columns:repeat(2,1fr)}}
@media(max-width:600px){.list-grid{grid-template-columns:1fr}}

/* MOBILE VIEW */
@media(max-width:900px){
  .topbar{display:flex;align-items:center}
  .sidebar{right:-300px}
  .sidebar.show{right:0}
  .content{margin-right:0;margin-top:60px}
}
</style>
</head>
<body>

<!-- MOBILE TOP BAR -->
<div class="topbar">
  <button id="openMenu">â˜°</button>
  EduAttend
</div>

<!-- SIDEBAR -->
<div class="sidebar hidden" id="sidebar">
  <div class="brand">EduAttend</div>
  <div class="menu">
    <button id="studentsBtn">Ø§Ù„Ø·Ù„Ø§Ø¨</button>
    <button id="lessonsBtn">Ø§Ù„Ø­ØµØµ</button>
    <button id="logoutBtn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
  </div>
</div>

<!-- CONTENT -->
<div class="content">

  <!-- STUDENTS PAGE -->
  <section id="students" class="page" hidden>
    <div class="box">
      <div class="title">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</div>

      <div class="filter-container">
        <button class="tabBtn active" data-level="all">Ø§Ù„ÙƒÙ„</button>
        <button class="tabBtn" data-level="first">Ø£ÙˆÙ„Ù‰ Ø«Ø§Ù†ÙˆÙŠ</button>
        <button class="tabBtn" data-level="second">Ø«Ø§Ù†ÙŠ Ø«Ø§Ù†ÙˆÙŠ</button>
        <button class="tabBtn" data-level="third">Ø«Ø§Ù„Ø« Ø«Ø§Ù†ÙˆÙŠ</button>
      </div>

      <div class="box">
        <h3 style="color:var(--primary);margin-bottom:10px">Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</h3>
        <div class="form-grid">
          <input id="studentName" class="student-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨">
          <input id="studentCode" class="student-input" placeholder="ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
          <select id="studentLevel" class="student-input">
            <option value="first">Ø£ÙˆÙ„Ù‰ Ø«Ø§Ù†ÙˆÙŠ</option>
            <option value="second">Ø«Ø§Ù†ÙŠ Ø«Ø§Ù†ÙˆÙŠ</option>
            <option value="third">Ø«Ø§Ù„Ø« Ø«Ø§Ù†ÙˆÙŠ</option>
          </select>
          <button id="addStudentBtn" class="add-btn">Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨</button>
        </div>
      </div>

      <div class="box">
        <h3 style="color:var(--primary);margin-bottom:10px">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</h3>
        <div class="table-wrapper">
          <table class="res-table">
            <thead>
              <tr>
                <th>Ø§Ù„Ø§Ø³Ù…</th>
                <th>Ø§Ù„ÙƒÙˆØ¯</th>
                <th>Ø§Ù„Ù…Ø±Ø­Ù„Ø©</th>
                <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
              </tr>
            </thead>
            <tbody id="studentsList"></tbody>
          </table>
        </div>
      </div>

    </div>
  </section>


  <!-- LESSONS PAGE -->
  <section id="lessons" class="page" hidden>
    <div class="box">
      <div class="title">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­ØµØµ</div>

      <div class="box">
        <div class="form-grid">
          <input id="lessonTitle" class="student-input" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø­ØµØ©">
          <input id="lessonDate" type="date" class="student-input">
          <select id="lessonLevel" class="student-input">
            <option value="first">Ø£ÙˆÙ„Ù‰ Ø«Ø§Ù†ÙˆÙŠ</option>
            <option value="second">Ø«Ø§Ù†ÙŠ Ø«Ø§Ù†ÙˆÙŠ</option>
            <option value="third">Ø«Ø§Ù„Ø« Ø«Ø§Ù†ÙˆÙŠ</option>
          </select>
          <button id="addLessonBtn" class="add-btn">Ø¥Ø¶Ø§ÙØ© Ø­ØµØ©</button>
        </div>
      </div>

      <div class="box">
        <h3 style="color:var(--primary);margin-bottom:10px">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­ØµØµ</h3>
        <div id="lessonsList" class="list-grid"></div>
      </div>

    </div>
  </section>

  <!-- WELCOME -->
  <section id="welcome" class="page">
    <div class="box">
      <div class="title">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ğŸ‘‹</div>
      <p>Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù….</p>
    </div>
  </section>

</div>


<!-- ================= FIREBASE + JS ================= -->
<script type="module">
import {initializeApp} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import {getFirestore,collection,addDoc,getDocs,deleteDoc,updateDoc,doc} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
import {getAuth,signOut} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

const firebaseConfig={
  apiKey:"AIzaSyADeo3Nc2lqGKtnr_UqfNEZB28aGUCQsrc",
  authDomain:"eduattend-90a3d.firebaseapp.com",
  projectId:"eduattend-90a3d",
  storageBucket:"eduattend-90a3d.firebasestorage.app",
  messagingSenderId:"1002840427136",
  appId:"1:1002840427136:web:9de92f16a4303c8f117465"
};

const app=initializeApp(firebaseConfig);
const db=getFirestore(app);
const auth=getAuth();

/* ===== UI ===== */
const sidebar=document.getElementById("sidebar");
document.getElementById("openMenu").onclick=()=>sidebar.classList.toggle("hidden");

document.getElementById("studentsBtn").onclick=()=>showPage("students");
document.getElementById("lessonsBtn").onclick=()=>showPage("lessons");
document.getElementById("logoutBtn").onclick=()=>{signOut(auth);alert("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬");};

function showPage(id){
  document.querySelectorAll(".page").forEach(p=>p.hidden=true);
  document.getElementById(id).hidden=false;
  document.getElementById("welcome").hidden=true;
  sidebar.classList.add("hidden");
  window.scrollTo(0,0);
}

/* ===== STUDENTS ===== */
let currentFilter="all";
let students=[];

function translate(l){
  return l=="first"?"Ø£ÙˆÙ„Ù‰ Ø«Ø§Ù†ÙˆÙŠ":l=="second"?"Ø«Ø§Ù†ÙŠ Ø«Ø§Ù†ÙˆÙŠ":"Ø«Ø§Ù„Ø« Ø«Ø§Ù†ÙˆÙŠ";
}

async function loadStudents(){
  students=[];
  const snap=await getDocs(collection(db,"students"));
  snap.forEach(d=>students.push({id:d.id,...d.data()}));
  renderStudents();
}

function renderStudents(){
  const tbody=document.getElementById("studentsList");
  tbody.innerHTML="";
  const list=students.filter(s=>currentFilter==="all"||s.level===currentFilter);
  if(list.length===0){tbody.innerHTML="<tr><td colspan='4'>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨</td></tr>";return;}

  list.forEach(s=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td data-label="Ø§Ù„Ø§Ø³Ù…">${s.name}</td>
      <td data-label="Ø§Ù„ÙƒÙˆØ¯">${s.code||"-"}</td>
      <td data-label="Ø§Ù„Ù…Ø±Ø­Ù„Ø©">${translate(s.level)}</td>
      <td data-label="Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª">
        <button class='btn-ghost' onclick="editStudent('${s.id}','${s.name}')">ØªØ¹Ø¯ÙŠÙ„</button>
        <button class='btn-ghost' style='background:#ff4d4d;color:#fff' onclick="deleteStudent('${s.id}')">Ø­Ø°Ù</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

window.deleteStudent=async(id)=>{
  if(!confirm("Ù…Ø³Ø­ Ø§Ù„Ø·Ø§Ù„Ø¨ØŸ")) return;
  await deleteDoc(doc(db,"students",id));
  loadStudents();
};



  // Ø¥ÙƒÙ…Ø§Ù„ Ø¯Ø§Ù„Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨
  window.editStudent = async (id, name) => {
    const newName = prompt("ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…", name);
    if (newName === null) return;
    const trimmed = newName.trim();
    if (!trimmed) return alert("Ø§Ù„Ø§Ø³Ù… Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† ÙØ§Ø±ØºÙ‹Ø§");
    await updateDoc(doc(db, "students", id), { name: trimmed });
    await loadStudents();
  };

  // Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨ â†’ Firestore
  document.getElementById("addStudentBtn").addEventListener("click", async () => {
    const name = document.getElementById("studentName").value.trim();
    const code = document.getElementById("studentCode").value.trim();
    const level = document.getElementById("studentLevel").value;
    if (!name) return alert("Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨");
    await addDoc(collection(db, "students"), { name, code, level, createdAt: Date.now() });
    document.getElementById("studentName").value = "";
    document.getElementById("studentCode").value = "";
    document.getElementById("studentLevel").value = "first";
    await loadStudents();
  });

  // ÙÙ„ØªØ± Ø§Ù„Ø£Ø²Ø±Ø§Ø± (pills)
  document.querySelectorAll(".tabBtn").forEach(btn => {
    btn.addEventListener("click", (e) => {
      document.querySelectorAll(".tabBtn").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      currentFilter = btn.dataset.level;
      renderStudents();
    });
  });

  /* ===== Lessons: add / load / render / enter attendance ===== */

  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­ØµØµ Ù…Ù† Firestore
  async function loadLessons() {
    currentLessons = [];
    const snap = await getDocs(collection(db, "lessons"));
    snap.forEach(d => currentLessons.push({ id: d.id, ...d.data() }));
    renderLessons();
  }

  // Ø¹Ø±Ø¶ Ø§Ù„Ø­ØµØµ
  function renderLessons() {
    const box = document.getElementById("lessonsList");
    box.innerHTML = "";
    if (currentLessons.length === 0) {
      box.innerHTML = `<div style="color:#666">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­ØµØµ</div>`;
      return;
    }
    currentLessons.forEach(l => {
      const card = document.createElement("div");
      card.className = "lesson-card";
      card.innerHTML = `
        <h4>${escapeHtml(l.title)}</h4>
        <div class="lesson-meta">${l.date ? l.date + " â€¢ " : ""}${translate(l.level)}</div>
        <div style="display:flex;gap:8px;margin-top:10px">
          <button class="btn-ghost" onclick="enterLesson('${l.id}')">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø­ØµØ©</button>
          <button class="btn-ghost" style="margin-inline-start:auto;background:#ff4d4d;color:#fff" onclick="deleteLesson('${l.id}')">Ø­Ø°Ù</button>
        </div>
      `;
      box.appendChild(card);
    });
  }

  // Ø­Ø°Ù Ø­ØµØ©
  window.deleteLesson = async (id) => {
    if (!confirm("Ø­Ø°Ù Ø§Ù„Ø­ØµØ©ØŸ")) return;
    await deleteDoc(doc(db, "lessons", id));
    await loadLessons();
  };

  // Ø¥Ø¶Ø§ÙØ© Ø­ØµØ© (ØªÙˆÙ„ÙŠØ¯ Ù…ÙØªØ§Ø­ Ø¯Ø§Ø®Ù„ÙŠ key)
  document.getElementById("addLessonBtn").addEventListener("click", async () => {
    const title = document.getElementById("lessonTitle").value.trim();
    const date = document.getElementById("lessonDate").value || "";
    const level = document.getElementById("lessonLevel").value;
    if (!title) return alert("Ø§ÙƒØªØ¨ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø­ØµØ©");
    const key = "lesson_" + ("" + Math.floor(10000000000 + Math.random() * 90000000000));
    await addDoc(collection(db, "lessons"), { title, date, level, key, createdAt: Date.now() });
    document.getElementById("lessonTitle").value = "";
    document.getElementById("lessonDate").value = "";
    document.getElementById("lessonLevel").value = "first";
    await loadLessons();
  });

  // Ø­Ù…Ø§ÙŠØ©: Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ù‡Ø±ÙˆØ¨ Ù…Ù† Ø§Ù„Ù€ HTML
  function escapeHtml(s) {
    return String(s).replace(/[&<>"]/g, (m) => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;' }[m]));
  }

  // Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø­ØµØ© â€” ÙŠØ¹Ø±Ø¶ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø­Ø¶ÙˆØ±
  window.enterLesson = async (lessonId) => {
    // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­ØµØ©
    const lessonSnap = await getDocs(collection(db, "lessons"));
    const lesson = currentLessons.find(x => x.id === lessonId);
    if (!lesson) return alert("Ø§Ù„Ø­ØµØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©");

    // Ø§Ø®ØªÙØ§Ø¡ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø¯Ø§Ø®Ù„ Ø§Ù„Ù€ lessons box
    const lessonsBox = document.querySelector("#lessons .box");
    // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ù„ÙˆØ­Ø© Ø­Ø¶ÙˆØ± Ù‚Ø¯ÙŠÙ…Ø©
    const existing = document.getElementById("attendancePanel");
    if (existing) existing.remove();

    // Ø¥Ù†Ø´Ø§Ø¡ Ù„ÙˆØ­Ø© Ø§Ù„Ø­Ø¶ÙˆØ±
    const panel = document.createElement("div");
    panel.id = "attendancePanel";
    panel.className = "box";
    panel.innerHTML = `
      <div class="attendance-header">
        <div>
          <strong>${escapeHtml(lesson.title)}</strong><br>
          <small class="lesson-meta">${lesson.date ? lesson.date + " â€¢ " : ""}${translate(lesson.level)} â€¢ Ø§Ù„Ù…ÙØªØ§Ø­: <code>${lesson.key}</code></small>
        </div>
        <div>
          <button class="btn-ghost" id="closeAttBtn">Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
        </div>
      </div>
      <div class="att-list" id="attList"></div>
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end;">
        <button class="btn-success" id="saveAttendanceBtn">Ø­ÙØ¸ Ø§Ù„Ø­Ø¶ÙˆØ±</button>
      </div>
    `;
    lessonsBox.appendChild(panel);

    // Ø¬Ù„Ø¨ Ø§Ù„Ø·Ù„Ø§Ø¨ Ù…Ù† Ø§Ù„Ø°Ø§ÙƒØ±Ø© (ØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡Ù… Ù…Ù† Firestore) Ø­Ø³Ø¨ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø­ØµØ©
    const same = students.filter(s => s.level === lesson.level);
    const listDiv = document.getElementById("attList");
    listDiv.innerHTML = "";
    if (same.length === 0) {
      listDiv.innerHTML = `<div style="color:#666">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø±Ø­Ù„Ø©</div>`;
    } else {
      // Ø¬Ù„Ø¨ Ø­Ø¶ÙˆØ± Ù…ÙˆØ¬ÙˆØ¯ Ø¥Ù† ÙˆÙØ¬Ø¯
      const attSnap = await getDocs(collection(db, "attendance"));
      // Ø§Ø¨Ø­Ø« Ø¥Ù† ÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ù„Ù„Ø­ØµØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ© (Ø¹Ù† Ø·Ø±ÙŠÙ‚ lesson.key) â€” Ø³Ù†Ø³ØªØ®Ø¯Ù… field lessonKey
      let existingRecord = null;
      attSnap.forEach(d => {
        const data = d.data();
        if (data.lessonKey === lesson.key) existingRecord = { id: d.id, ...data };
      });
      const present = existingRecord ? (existingRecord.presentIds || []) : [];

      // Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø·Ù„Ø§Ø¨ Ù…Ø¹ Checkbox
      same.forEach(s => {
        const row = document.createElement("div");
        row.className = "att-item";
        row.innerHTML = `
          <div>${escapeHtml(s.name)}</div>
          <div><input type="checkbox" data-id="${s.id}" ${present.includes(s.id) ? "checked" : ""}></div>
        `;
        listDiv.appendChild(row);
      });

      // Ø¥Ø±ÙØ§Ù‚ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ù„Ø£Ø²Ø±Ø§Ø±
      document.getElementById("closeAttBtn").addEventListener("click", () => {
        panel.remove();
        loadLessons();
      });

      document.getElementById("saveAttendanceBtn").addEventListener("click", async () => {
        const boxes = Array.from(listDiv.querySelectorAll("input[type='checkbox']"));
        const presentIds = boxes.filter(cb => cb.checked).map(cb => Number(cb.dataset.id));
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø³Ø¬Ù„ Ù…ÙˆØ¬ÙˆØ¯ Ù†Ø­Ø¯Ø«Ù‡ ÙˆØ¥Ù„Ø§ Ù†Ø¶ÙŠÙ Ø¬Ø¯ÙŠØ¯
        if (existingRecord) {
          await updateDoc(doc(db, "attendance", existingRecord.id), { presentIds, updatedAt: Date.now() });
        } else {
          await addDoc(collection(db, "attendance"), { lessonKey: lesson.key, presentIds, createdAt: Date.now() });
        }
        alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø­Ø¶ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­");
        panel.remove();
        loadLessons();
      });
    }
  };

  /* ================= Final init ================= */
  // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ ÙˆØ§Ù„Ø­ØµØµ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
  await loadStudents();
  await loadLessons();

</script>
</body>
</html>

